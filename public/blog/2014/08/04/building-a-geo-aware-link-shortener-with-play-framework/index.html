
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a geo-aware link shortener with Play Framework - Matthias Nehlsen</title>
  <meta name="author" content="Matthias Nehlsen">

  
  <meta name="description" content="Last week I wrote about blog monetization through the Amazon Affiliate Program. I needed a way to serve country specific URLs depending on the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://matthiasnehlsen.com/blog/2014/08/04/building-a-geo-aware-link-shortener-with-play-framework">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Matthias Nehlsen" type="application/atom+xml">
  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Matthias Nehlsen</a></h1>
  
    <h2>Software, Data and Stuff</h2>
    
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:matthiasnehlsen.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/reviews">Reviews</a></li>
  <li><a href="/reading-lists">Reading Lists</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  <a href="https://plus.google.com/100986586701798521209" rel="publisher"></a>


  <header>
    
      <h1 class="entry-title">Building a geo-aware link shortener with Play Framework</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-04T15:16:00+02:00" pubdate data-updated="true">08/04/2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong><a href="http://matthiasnehlsen.com/blog/2014/08/01/weekly-update/">Last week</a></strong> I wrote about blog monetization through the <strong><a href="https://affiliate-program.amazon.com">Amazon Affiliate Program</a></strong>. I needed a way to serve country specific URLs depending on the location of the page visitor, so I wrote a geo-aware link shortener using <strong><a href="http://www.playframework.com">Play Framework</a></strong>. This week I would like to introduce that application. The source code is available on <strong><a href="https://github.com/matthiasn/amzn-geo-lookup">GitHub</a></strong>. You may find that tool useful for your own purposes, or you might just want to read this as a tutorial on how to call backend services with Play Framework and the asynchrous <strong><a href="http://www.playframework.com/documentation/2.3.2/ScalaWS">WS client</a></strong>.</p>

<!-- more -->


<p>Let us define the purpose of this application: visitors (for example on a blog) shall be redirected to country-specific banners, slideshows or plain links for the matching Amazon store front for the country of origin of the request, or if none exists for the visitor&#8217;s country, the U.S. store. Links should be shortened as well. Let&#8217;s look at an <strong>example</strong>.</p>

<p>The link for <code>http://r.matthiasnehlsen.com/amazon-landing/link</code> is requested. Then, depending on the visitor&#8217;s country, the following happens:</p>

<p>1) request from the U.S.: the request is redirected to <strong><a href="http://www.amazon.com/?_encoding=UTF8&amp;camp=1789&amp;creative=390957&amp;linkCode=ur2&amp;tag=matthiasnehls-20&amp;linkId=2JYSWJ7Q5CJ7F7QW">amazon.com</a></strong></p>

<p>2) request from the UK: the request is redirected to <strong><a href="http://www.amazon.co.uk/?_encoding=UTF8&amp;camp=1634&amp;creative=19450&amp;linkCode=ur2&amp;tag=matthiasneh0c-21&amp;linkId=O6XF3Z2DDAH6EUXU" title="">amazon.co.uk</a></strong></p>

<p>3) requests from countries that do not have an Amazon store (or rather also where I have not created an account, such as India, Brazil, China, Japan) are redirected <strong><a href="http://www.amazon.com/?_encoding=UTF8&amp;camp=1789&amp;creative=390957&amp;linkCode=ur2&amp;tag=matthiasnehls-20&amp;linkId=2JYSWJ7Q5CJ7F7QW">amazon.com</a></strong> as well.</p>

<p>You can try this for yourself by following <strong><a href="http://r.matthiasnehlsen.com/amazon-landing/link">this link</a></strong>. When you click it, you should be directed to your country&#8217;s own store if you&#8217;re from the United States, Canada, the United Kingdom, France, Germany, Spain or Italy, or to the U.S. otherwise.</p>

<p>Now building this application was surprisingly simple with <strong><a href="http://www.playframework.com">Play Framework</a></strong>. The relevant code easily fits on a single printed page. Before we get into the details, we will need a backend service for the actual lookup of the requesting IP address. There is one well working open source service for that already: <strong><a href="http://freegeoip.net">freegeoip</a></strong>. Freeogeoip is also running as a free online service, but I would rather run this myself, as that will give me a much faster and more predictable response time when there are only local requests. In fact, doing the GeoIP lookup locally only requires a consistent single digit number of milliseconds.</p>

<h2>Installing freegeoip</h2>

<p>You really only need to follow the <strong><a href="https://github.com/fiorix/freegeoip">instructions here</a></strong>. That worked well for me both on my development Mac and on my Ubuntu server, with a slight change in the <strong><a href="http://upstart.ubuntu.com">upstart</a></strong> script on Ubuntu, which I have commited to the project as a <strong><a href="https://github.com/fiorix/freegeoip/commit/90e974c653631e135e3e4e6ed08df6da39c7cef4">pull request</a></strong>.</p>

<h2>Building the link shortener with Play Framework</h2>

<p>We will need to be using three building blocks of Play applications: the <strong><a href="http://www.playframework.com/documentation/2.3.2/ScalaWS">WS client</a></strong>, <strong><a href="http://www.playframework.com/documentation/2.2.3/ScalaAsync">async controller actions</a></strong> and <strong><a href="http://www.playframework.com/documentation/2.2.3/ScalaJson">JSON parsing</a></strong>. A client requests a resource, which is handled by an async action. Inside this action, the WS client performs a GeoIP lookup by calling the local freegeoip service. The result of this async WS call, which is JSON, is then parsed for the country code matching the request. Then the model is asked for the URL matching the requested resource and country. We will look at the source code below, but first here is a flowchart:</p>

<p><img class="left" src="/images/amzn-geo-lookup.png" title="'flowchart'" ></p>

<p>I hope this flowchart helps a little in following through the source code below.</p>

<figure class='code'><figcaption><span>Async controller action</span><a href='https://github.com/matthiasn/amzn-geo-lookup/blob/e75c16d198f9f266fa63dbe463856982a1b4fe22/app/controllers/Application.scala'>Application.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">controllers</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.mvc._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.ws.WS</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.concurrent.Execution.Implicits.defaultContext</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">model._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Controller Action for redirecting requester to URL matching the shortUrl and the country for the remote address,</span>
</span><span class='line'><span class="cm">   * otherwise when shortUrl exists but country does not have a configured URL, the U.S. entry as a fallback. Should</span>
</span><span class='line'><span class="cm">   * the entry for the U.S. store also not exist, the default URL is used.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The country of the requester is determined by performing a GeoIP lookup. For this, a local installation of</span>
</span><span class='line'><span class="cm">   * freegeoip is expected (https://github.com/fiorix/freegeoip).</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * Handled errors:</span>
</span><span class='line'><span class="cm">   *   - freegeoip not running -&gt; fallback URL</span>
</span><span class='line'><span class="cm">   *   - freegeoip not responding within 100ms -&gt; fallback URL (critical, script loading blocks page load)</span>
</span><span class='line'><span class="cm">   *   - freegeoip responds with code other than 200 -&gt; fallback URL</span>
</span><span class='line'><span class="cm">   * The fallback URL is the U.S store link for existing shortened links and a specified general default URL otherwise.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   **/</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">redirect</span><span class="o">(</span><span class="n">shortUrl</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">.</span><span class="n">async</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">req</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">fallbackUrl</span> <span class="k">=</span> <span class="nc">Links</span><span class="o">.</span><span class="n">redirectMap</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">shortUrl</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">format</span> <span class="o">+</span> <span class="s">&quot;.US&quot;</span><span class="o">).</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">Links</span><span class="o">.</span><span class="n">defaultRedirect</span><span class="o">)</span>
</span><span class='line'>      <span class="nc">WS</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="nc">Links</span><span class="o">.</span><span class="n">geoLookupAddress</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="n">remoteAddress</span><span class="o">).</span><span class="n">withRequestTimeout</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">get</span><span class="o">().</span><span class="n">map</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">geoRes</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">geoRes</span><span class="o">.</span><span class="n">status</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">200</span> <span class="k">=&gt;</span>
</span><span class='line'>              <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="o">(</span><span class="n">geoRes</span><span class="o">.</span><span class="n">json</span> <span class="o">\</span> <span class="s">&quot;country_code&quot;</span><span class="o">).</span><span class="n">asOpt</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">cc</span> <span class="k">=&gt;</span>
</span><span class='line'>                  <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="n">shortUrl</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">format</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">cc</span>
</span><span class='line'>                  <span class="nc">ReqLogger</span><span class="o">.</span><span class="n">logCc</span><span class="o">(</span><span class="n">shortUrl</span><span class="o">,</span> <span class="n">format</span><span class="o">,</span> <span class="n">cc</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>                  <span class="nc">Links</span><span class="o">.</span><span class="n">redirectMap</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
</span><span class='line'>              <span class="o">}.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">fallbackUrl</span><span class="o">)</span>
</span><span class='line'>              <span class="nc">ReqLogger</span><span class="o">.</span><span class="n">logUrl</span><span class="o">(</span><span class="n">shortUrl</span><span class="o">,</span> <span class="n">format</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span>
</span><span class='line'>              <span class="nc">Redirect</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="n">status</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span>
</span><span class='line'>              <span class="nc">ReqLogger</span><span class="o">.</span><span class="n">logGeoFail</span><span class="o">(</span><span class="n">shortUrl</span><span class="o">,</span> <span class="n">format</span><span class="o">,</span> <span class="s">&quot;Status &quot;</span> <span class="o">+</span> <span class="n">status</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'>              <span class="nc">Redirect</span><span class="o">(</span><span class="n">fallbackUrl</span><span class="o">)</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}.</span><span class="n">recover</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span>
</span><span class='line'>          <span class="nc">ReqLogger</span><span class="o">.</span><span class="n">logGeoFail</span><span class="o">(</span><span class="n">shortUrl</span><span class="o">,</span> <span class="n">format</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class='line'>          <span class="nc">Redirect</span><span class="o">(</span><span class="n">fallbackUrl</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is really all, including all the imports and four calls to a request logger. The actual code is a mere <strong>23 lines</strong> long, including error handling. Let us go through this line by line. <em>redirect</em> is a controller method that takes two parameters, <em>shortUrl</em> and <em>format</em>, both of which are Strings. They come from the route definition:</p>

<figure class='code'><figcaption><span>routes</span><a href='https://raw.githubusercontent.com/matthiasn/amzn-geo-lookup/e75c16d198f9f266fa63dbe463856982a1b4fe22/conf/routes'>routes </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>GET   /:shortUrl/:format   controllers.Application.redirect(shortUrl: String, format: String)
</span></code></pre></td></tr></table></div></figure>


<p>The above configuration means that the application will call <em>controllers.Application.redirect</em> with the two strings it parses out of the request&#8217;s path.</p>

<p>The controller action is built by play&#8217;s <strong><a href="http://www.playframework.com/documentation/2.2.3/api/scala/index.html#play.api.mvc.ActionBuilder">ActionBuilder</a></strong> by calling <em>Action.async</em> with a block that takes a <em>request</em> of type <strong><a href="http://www.playframework.com/documentation/2.2.3/api/scala/index.html#play.api.mvc.Request">play.api.mvc.Request</a></strong> and returns the future of a result. Next we construct a fallback link to be delivered when the following GeoIP lookup fails in one way or another.</p>

<p>Next we fire up an asynchronous call to the local <strong>freegeoip</strong> instance for the IP address derived from the request. I only give this a timeout of 100 milliseconds as I do not want to hold up page loading for longer than that, no matter what. In reality, this is plenty for this local lookup when things are running smoothly, I usually only measured around 7 milliseconds to fulfil this request end to end.</p>

<p>First, we create the <em>fallbackUrl</em> which will either be the specific link to the U.S. store or a default URL when the map lookup with the provided <em>shortUrl</em> and <em>format</em> is unsuccessful. This is either the corresponding link to the shortUrl but for the U.S. store, should that exist in the model, or a default URL otherwise (also specified in the model).</p>

<p>Next, we create a <strong><a href="http://www.playframework.com/documentation/2.2.3/api/scala/index.html#play.api.libs.ws.WS$$WSRequestHolder">WsRequestHolder</a></strong> by specifying the URL, setting the timeout. Then we call <em>get()</em> on the request holder and <em>map</em> on it by providing a function to apply to a successful result of the future. In here, the result could either be a status code of <strong><a href="http://en.wikipedia.org/wiki/List_of_HTTP_status_codes">200</a></strong> or something else, for example a <strong><a href="http://en.wikipedia.org/wiki/List_of_HTTP_status_codes">400</a></strong> when the request failed. Such a failure can occur when calling freeogeoip locally from an IPv6 address, as is the case locally on my Mac. When the result is a <strong>200</strong>, we expect the result body to contain valid JSON, so we parse it for the country code. This parsing step returns the Option of a String, depending on if it found the specified JSON property or not. We <em>flatMap</em> with a function that itself returns an Option of a URL String by taking the parsed country code String and looking that up in the <strong><a href="http://docs.scala-lang.org/overviews/collections/maps.html">Map</a></strong> of the model. If such an entry exists, the Map lookup returns Some(urlString), otherwise it returns <strong><a href="http://www.scala-lang.org/api/current/index.html#scala.None$">None</a></strong>. Using <em>flatMap</em> now returns a single option instead of having to map on two options. Then we call <em>getOrElse</em> on the resulting Option, retrieving either the lookup result or the <em>fallbackUrl</em>. When encountering any result code other than <strong>200</strong>, we redirect to the <em>fallbackUrl</em>.</p>

<p>Now there is a second failure scenario where not the result code indicates what went wrong but instead the WS call fails altogether. That case would result in an failed future, which we can catch using <em>recover</em>, again redirecting to the <em>fallbackUrl</em>. For understanding what is going on here, it is important to realize that both the map combinator on the WS result and the recover combinator return new futures, both of type <strong><a href="http://www.playframework.com/documentation/2.2.3/api/scala/index.html#play.api.mvc.SimpleResult">SimpleResult</a></strong>. I have found <strong><a href="http://docs.scala-lang.org/overviews/core/futures.html">this article</a></strong> in the Scala documentation helpful for understanding futures better. We could have used pattern matching on specific types of exceptions but that wasn&#8217;t necessary in this case, as we always want to simply return a Redirect to the <em>fallbackUrl</em> (plus log the exception).</p>

<h2>The model</h2>

<p>Right now all the data lives in the model&#8217;s source code. Obviously it would be better to utilize a database for this purpose, but for a first version, this serves us alright. The model is really just a <strong><a href="http://docs.scala-lang.org/overviews/collections/maps.html">Map</a></strong>. Here&#8217;s a shortened version as an example:</p>

<figure class='code'><figcaption><span>Links model amzn-geo-lookup/blob/e75c16d198f9f266fa63dbe463856982a1b4fe22/app/model/Links.scala Links.scala </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">model</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Links</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">redirectMap</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">](</span>
</span><span class='line'>    <span class="c1">// Amazon landing page</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.US&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;http://www.amazon.com/?_encoding=UTF8&amp;camp=1789&amp;creative=390957&amp;linkCode=ur2&amp;tag=matthiasnehls-20&amp;linkId=2JYSWJ7Q5CJ7F7QW&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.DE&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;http://www.amazon.de/?_encoding=UTF8&amp;camp=1638&amp;creative=19454&amp;linkCode=ur2&amp;site-redirect=de&amp;tag=matnehblo-21&amp;linkId=GTDGKZ677SJ76DR2&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.GB&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;http://www.amazon.co.uk/?_encoding=UTF8&amp;camp=1634&amp;creative=19450&amp;linkCode=ur2&amp;tag=matthiasneh0c-21&amp;linkId=O6XF3Z2DDAH6EUXU&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.FR&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;https://www.amazon.fr/?_encoding=UTF8&amp;camp=1642&amp;creative=19458&amp;linkCode=ur2&amp;tag=matthiasneh03-21&amp;linkId=WATXOGQM2BDD44FL&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.CA&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;http://www.amazon.ca/?_encoding=UTF8&amp;camp=15121&amp;creative=390961&amp;linkCode=ur2&amp;tag=matthiasneh0d-20&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.IT&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;https://www.amazon.it/?_encoding=UTF8&amp;camp=3370&amp;creative=24114&amp;linkCode=ur2&amp;tag=matthiasneh01-21&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;amazon-landing.link.ES&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;https://www.amazon.es/?_encoding=UTF8&amp;camp=3626&amp;creative=24822&amp;linkCode=ur2&amp;tag=matthiasne0ac-21&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Building this geo-aware link shortener (in a very basic form) was really easy with <strong><a href="http://www.playframework.com">Play Framework</a></strong>. I am currently using this tool for the lookup of Amazon store fronts for redirecting affiliate links to the country of the visitor. But there is no reason why this couldn&#8217;t be used for all kinds of other scenarios where such a country-specific redirection of requests might be useful.
Now of course it is not ideal to store the links in code. Instead, that data should live in a database of some kind, propably with the stored values cached inside the application to not introduce additional round-trips for every lookup. Placing the data in a model object is already the first step towards building that. The redirecting controller would not have to change at all when replacing this model object with one that internally uses a database. Then it would also be really useful to create new links from a user interface. That could for example easily be achieved with an AngularJS application for link maintenance. There&#8217;s surely stuff for me to do. Please let me know if you would find this more elaborate version I just described (database, UI) useful, may it be that you would use it yourself or that you would just like to follow along a tutorial in which we build this application. The more successful this application turns out to be in contributing to this blog, the more time I will find to work on these improvements. Thus, you can literally vote with your wallet by clicking on links delivered by the described application.</p>

<SCRIPT charset="utf-8" type="text/javascript" src="http://r.matthiasnehlsen.com/slideshow1/wide"> </SCRIPT>


<p>Please let me know about your thoughts. I will be happy to clarify anything that is not easy to understand just yet. Also please let me know if you encounter problems making any of this work for yourself.</p>

<p>That&#8217;s it for today, hope to see you back soon. And now that you have made it this far in the article, why don&#8217;t you follow me on Twitter <strong><a href="https://twitter.com/matthiasnehlsen">@matthiasnehlsen</a></strong> so you&#8217;ll be informed about the next article.</p>

<p>Cheers,
Matthias</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Matthias Nehlsen</span></span>

      








  


<time datetime="2014-08-04T15:16:00+02:00" pubdate data-updated="true">08/04/2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://matthiasnehlsen.com/blog/2014/08/04/building-a-geo-aware-link-shortener-with-play-framework/" data-via="matthiasnehlsen" data-counturl="http://matthiasnehlsen.com/blog/2014/08/04/building-a-geo-aware-link-shortener-with-play-framework/" >Tweet</a>
  

  
  <div class="g-plusone" data-size="medium"></div>
  

  
  
  
  
  <br />
  
  
    <div class="fb-like" data-send="true" data-width="600" data-show-faces="false"></div>
  
  
  <br />
  <br />
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/01/weekly-update/" title="Previous Post: Weekly Update: Buying time, AngularJS Meetup, Mountains">&laquo; Weekly Update: Buying time, AngularJS Meetup, Mountains</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/10/weekly-update/" title="Next Post: Weekly Update: AngularJS book, Geo-Lookup, Reading">Weekly Update: AngularJS book, Geo-Lookup, Reading &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
<section>
	<span>
		<img src="http://www.gravatar.com/avatar/3f6cb2a9b1057c35f284174063835d41?s=250" alt="Gravatar of Matthias Nehlsen " title="Gravatar of Matthias Nehlsen" />
	</span>
</section>
<section>
  <h1>About Me</h1>
  <p>Hello everyone. My name is Matthias Nehlsen and I am exploring functional programming, data visualization and real-time information processing.</p>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/08/25/weekly-update/">Weekly Update: AngularJS book, BirdWatch and Clojure, Web Components, Upstart and Play</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/weekly-update/">Weekly Update: git vs brain fart, Octopress, Sony A7, my audio setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/10/weekly-update/">Weekly Update: AngularJS book, Geo-Lookup, Reading</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/04/building-a-geo-aware-link-shortener-with-play-framework/">Building a geo-aware link shortener with Play Framework</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/01/weekly-update/">Weekly Update: Buying time, AngularJS Meetup, Mountains</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li><a href="https://github.com/matthiasn/birdwatch">BirdWatch</a>
      <p>Reactive web application using Play Framework 2.2 for consuming and visualizing live Tweets from the Twitter Streaming API.</p>
        <iframe src="http://ghbtns.com/github-btn.html?user=matthiasn&repo=birdwatch&type=watch&count=true"
          allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
    </li>
    <li><a href="https://github.com/matthiasn/sse-chat">sse-chat</a>
      <p>Chat example app using Server Sent Events plus REST calls. Client side implementations both in AngularJS and in React.</p>
      <iframe src="http://ghbtns.com/github-btn.html?user=matthiasn&repo=sse-chat&type=watch&count=true"
        allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
    </li>
    <li><a href="https://github.com/matthiasn/sse-perf">sse-perf</a>
      <p>Reactive web application using Play Framework 2.1 for load testing Server Sent Event streams (or other HTTP connections that deliver information in chunks).</p>
      <iframe src="http://ghbtns.com/github-btn.html?user=matthiasn&repo=sse-perf&type=watch&count=true"
        allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
    </li>  
    <li><a href="https://github.com/matthiasn/amzn-geo-lookup">amzn-geo-lookup</a>&nbsp;
        <p>Web application for redirecting requests depending on the country of the requesting IP address. Useful for Amazon Affiliate Links.</p>
        <iframe src="http://ghbtns.com/github-btn.html?user=matthiasn&repo=amzn-geo-lookup&type=watch&count=true"
          allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
      </li>
  </ul>
</section>
<section>
    <a name="signup"><h1>Subscribe</h1></a>
    <div id="mc_embed_signup">
      <form action="http://matthiasnehlsen.us7.list-manage1.com/subscribe/post?u=798fd7b50a1d9cc58be41c2af&amp;id=eb7a7193c5" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div class="mc-field-group">
          <label for="mce-EMAIL">Enter your email to receive updates</label>
          <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="you@email.com" />
        </div>
        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
      <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </form>
    
    <br />
  </div>
</section>
<SCRIPT charset="utf-8" type="text/javascript" src="http://r.matthiasnehlsen.com/slideshow1/narrow"> </SCRIPT>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Matthias Nehlsen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'matthiasnehlsen';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://matthiasnehlsen.com/blog/2014/08/04/building-a-geo-aware-link-shortener-with-play-framework/';
        var disqus_url = 'http://matthiasnehlsen.com/blog/2014/08/04/building-a-geo-aware-link-shortener-with-play-framework/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  
  <script src="//use.typekit.net/rco1jij.js"></script>
  <script>try{Typekit.load();} catch (e){}</script>

  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40261983-1', 'auto');
  ga('send', 'pageview');
</script>


  

</body>
</html>
